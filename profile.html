<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Security Lab</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">üîê Security Lab</div>
            <ul class="nav-menu">
                <li><a href="index.html">Ana Sayfa</a></li>
                <li><a href="profile.html">Profil</a></li>
                <li><a href="admin.html">Admin</a></li>
                <li><a href="#" onclick="logout()">√áƒ±kƒ±≈ü</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="hero">
            <h1>üë§ Kullanƒ±cƒ± Profili</h1>
            <p class="subtitle">IDOR | CSRF | XSS Vulnerabilities</p>
        </div>

        <div id="profile-content" class="test-categories">
            <!-- Profile will be loaded here -->
        </div>
    </div>

    <footer>
        <p>üîì Deliberately Vulnerable Profile Page</p>
    </footer>

    <script src="js/auth.js"></script>
    <script>
        // Check authentication (weak client-side check)
        if (!isLoggedIn()) {
            alert('Please login first');
            window.location.href = 'login.html';
        }

        // Vulnerable: IDOR - Get user ID from URL or use logged in user
        const urlParams = new URLSearchParams(window.location.search);
        const profileUserId = urlParams.get('user') || getUserId();

        // Vulnerable: No authorization check - can view any user's profile
        const users = {
            '1': {
                id: 1,
                name: 'Admin User',
                email: 'admin@test.com',
                role: 'admin',
                // Sensitive data exposed:
                password: 'Admin123!',
                ssn: '123-45-6789',
                creditCard: '4532-1234-5678-9010',
                salary: 150000,
                address: '123 Admin Street, City, 12345',
                phone: '+1-555-0100',
                notes: 'System administrator with full access'
            },
            '2': {
                id: 2,
                name: 'Regular User',
                email: 'user@test.com',
                role: 'user',
                password: 'User123!',
                ssn: '987-65-4321',
                creditCard: '4532-9876-5432-1098',
                salary: 75000,
                address: '456 User Avenue, Town, 54321',
                phone: '+1-555-0200',
                notes: 'Standard user account'
            },
            '3': {
                id: 3,
                name: 'Test User',
                email: 'test@test.com',
                role: 'user',
                password: 'Test123!',
                ssn: '555-12-3456',
                creditCard: '4532-5555-1234-5678',
                salary: 60000,
                address: '789 Test Road, Village, 67890',
                phone: '+1-555-0300',
                notes: 'Test account for development'
            }
        };

        const currentProfile = users[profileUserId];

        if (currentProfile) {
            document.getElementById('profile-content').innerHTML = `
                <div class="category-card">
                    <h2>üìã Profile Information</h2>
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è Viewing Profile ID: ${profileUserId} (Try changing ?user=1, ?user=2, ?user=3 in URL)
                    </div>
                    <table style="width: 100%;">
                        <tr>
                            <td><strong>ID:</strong></td>
                            <td>${currentProfile.id}</td>
                        </tr>
                        <tr>
                            <td><strong>Name:</strong></td>
                            <td id="userName">${currentProfile.name}</td>
                        </tr>
                        <tr>
                            <td><strong>Email:</strong></td>
                            <td>${currentProfile.email}</td>
                        </tr>
                        <tr>
                            <td><strong>Role:</strong></td>
                            <td><span class="badge ${currentProfile.role === 'admin' ? 'badge-danger' : 'badge-success'}">${currentProfile.role}</span></td>
                        </tr>
                        <tr style="background: #fee2e2;">
                            <td><strong>Password:</strong></td>
                            <td>${currentProfile.password} <span class="badge badge-danger">EXPOSED!</span></td>
                        </tr>
                        <tr style="background: #fee2e2;">
                            <td><strong>SSN:</strong></td>
                            <td>${currentProfile.ssn} <span class="badge badge-danger">EXPOSED!</span></td>
                        </tr>
                        <tr style="background: #fee2e2;">
                            <td><strong>Credit Card:</strong></td>
                            <td>${currentProfile.creditCard} <span class="badge badge-danger">EXPOSED!</span></td>
                        </tr>
                        <tr>
                            <td><strong>Salary:</strong></td>
                            <td>$${currentProfile.salary}</td>
                        </tr>
                        <tr>
                            <td><strong>Address:</strong></td>
                            <td>${currentProfile.address}</td>
                        </tr>
                        <tr>
                            <td><strong>Phone:</strong></td>
                            <td>${currentProfile.phone}</td>
                        </tr>
                        <tr>
                            <td><strong>Notes:</strong></td>
                            <td>${currentProfile.notes}</td>
                        </tr>
                    </table>
                </div>

                <div class="category-card">
                    <h2>‚úèÔ∏è Update Profile (CSRF Vulnerable)</h2>
                    <form id="updateForm">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" id="updateName" value="${currentProfile.name}">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="updateEmail" value="${currentProfile.email}">
                        </div>
                        <div class="form-group">
                            <label>Role:</label>
                            <select id="updateRole">
                                <option value="user" ${currentProfile.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="admin" ${currentProfile.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                        <p class="alert alert-danger" style="margin-top: 1rem;">‚ö†Ô∏è NO CSRF TOKEN!</p>
                    </form>
                </div>

                <div class="category-card">
                    <h2>üéØ Vulnerability Tests</h2>
                    <ul>
                        <li><strong>IDOR:</strong> Change ?user= in URL to access other profiles</li>
                        <li><strong>CSRF:</strong> Form has no CSRF protection</li>
                        <li><strong>XSS:</strong> Try injecting in name field</li>
                        <li><strong>Sensitive Data Exposure:</strong> Passwords, SSN, Credit Cards visible</li>
                        <li><strong>Mass Assignment:</strong> Can change role to admin via form</li>
                    </ul>
                    <button class="btn btn-warning" onclick="testXSS()">Test Stored XSS</button>
                </div>

                <div class="category-card">
                    <h2>üìä Session Information</h2>
                    <div class="code-block" id="sessionInfo"></div>
                </div>
            `;

            // Show session info
            document.getElementById('sessionInfo').textContent = JSON.stringify({
                sessionToken: localStorage.getItem('sessionToken'),
                userEmail: localStorage.getItem('userEmail'),
                userRole: localStorage.getItem('userRole'),
                userId: localStorage.getItem('userId'),
                currentProfile: profileUserId,
                viewingOtherProfile: profileUserId !== getUserId()
            }, null, 2);

            // Handle form submission (vulnerable to CSRF)
            document.getElementById('updateForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newName = document.getElementById('updateName').value;
                const newEmail = document.getElementById('updateEmail').value;
                const newRole = document.getElementById('updateRole').value;

                // Vulnerable: Stored XSS
                document.getElementById('userName').innerHTML = newName;

                alert(`Profile updated!\nName: ${newName}\nEmail: ${newEmail}\nRole: ${newRole}\n\n‚ö†Ô∏è No server-side validation!\n‚ö†Ô∏è XSS possible in name field!`);

                // Vulnerable: Mass assignment - user can change their role
                if (newRole === 'admin') {
                    localStorage.setItem('userRole', 'admin');
                    alert('üö® Role escalated to admin!');
                }
            });
        } else {
            document.getElementById('profile-content').innerHTML = `
                <div class="alert alert-danger">
                    <h2>User not found</h2>
                    <p>Profile ID ${profileUserId} does not exist.</p>
                    <p>Try ?user=1, ?user=2, or ?user=3</p>
                </div>
            `;
        }

        function testXSS() {
            const xssPayload = '<img src=x onerror="alert(\'Stored XSS!\')"> Hacked!';
            document.getElementById('updateName').value = xssPayload;
            alert('XSS payload loaded! Click Update Profile to test.');
        }

        // Vulnerable: Exposing all user data in console
        console.log('All users:', users);
        console.log('Current profile:', currentProfile);
    </script>
</body>
</html>
